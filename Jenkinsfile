pipeline {
    agent any
    environment {
        BACKEND_IMAGE = 'backend-image'
        FRONTEND_IMAGE = 'frontend-image'
    }
    parameters {
        string(
            name: 'IDENTIFICATION_MESSAGE',
            defaultValue: '',
            description: 'The identification message to be used in the Docker image and its further artifacts'
        )
    }
    stages {
        stage('Synchronizing the Repository') {
            steps {
                checkout scm
            }
        }
        stage('Building Phase of Docker Images') {
            parallel {
                stage('Backend Building') {
                    steps {
                        script {
                            def identificationMessage = params.IDENTIFICATION_MESSAGE ?: sh(returnStdout: true, script: 'git log -1 --oneline').trim().tokenize()[0]
                            sh("echo 'Building Backend image with identification message: ${identificationMessage}'")
                            docker.build("${env.BACKEND_IMAGE}:${identificationMessage}", '-f Dockerfile.Backend .')
                            stash includes: "backend-scan-${identificationMessage}.json", name: "backend-${identificationMessage}"
                        }
                    }
                }
                stage('Frontend Building') {
                    steps {
                        script {
                            def identificationMessage = params.IDENTIFICATION_MESSAGE ?: sh(returnStdout: true, script: 'git log -1 --oneline').trim().tokenize()[0]
                            sh("echo 'Building Frontend image with identification message: ${identificationMessage}'")
                            docker.build("${env.FRONTEND_IMAGE}:${identificationMessage}", '-f Dockerfile.Frontend .')
                            stash includes: "frontend-scan-${identificationMessage}.json", name: "frontend-${identificationMessage}"
                        }
                    }
                }
            }
        }
        stage('Verification Of Build') {
            steps {
                script {
                    if (currentBuild.result == 'FAILURE' || currentBuild.result == 'UNSTABLE') {
                        sh("echo 'Error is there Due to previous stages, as a Build-Status as ${currentBuild.result}'")
                        error('Aborting pipeline due to build errors.')
                    } else {
                        sh('echo "Till now Process of Building the Build files has been int to SUCCESS."')
                    }
                }
            }
        }
        stage('Vulnerability Scanning the Images Parallely') {
            parallel {
                stage('Scanning Backend Image') {
                    steps {
                        script {
                            def identificationMessage = params.IDENTIFICATION_MESSAGE ?: sh(returnStdout: true, script: 'git log -1 --oneline').trim().tokenize()[0]
                            sh("echo 'Scanning Backend image with identification message: ${identificationMessage}'")
                            def scanResult = sh(script: "docker scan ${env.BACKEND_IMAGE}:${identificationMessage} --json", returnStdout: true).trim()
                            writeFile file: "backend-scan-${identificationMessage}.json", text: scanResult
                            stash includes: "backend-scan-${identificationMessage}.json", name: "backend-scan-${identificationMessage}"
                        }
                    }
                }
                stage('Scanning Frontend Image') {
                    steps {
                        script {
                            def identificationMessage = params.IDENTIFICATION_MESSAGE ?: sh(returnStdout: true, script: 'git log -1 --oneline').trim().tokenize()[0]
                            sh("echo 'Scanning Frontend image with identification message: ${identificationMessage}'")
                            def scanResult = sh(script: "docker scan ${env.FRONTEND_IMAGE}:${identificationMessage} --json", returnStdout: true).trim()
                            writeFile file: "frontend-scan-${identificationMessage}.json", text: scanResult
                            stash includes: "frontend-scan-${identificationMessage}.json", name: "frontend-scan-${identificationMessage}"
                        }
                    }
                }
            }
        }
        stage('Unstash Results') {
            steps {
                script {
                    unstash "backend-scan-${params.IDENTIFICATION_MESSAGE ?: sh(returnStdout: true, script: 'git log -1 --oneline').trim().tokenize()[0]}"
                    unstash "frontend-scan-${params.IDENTIFICATION_MESSAGE ?: sh(returnStdout: true, script: 'git log -1 --oneline').trim().tokenize()[0]}"
                }
            }
        }
    }
    post {
        always {
            cleanWs()
        }
        success {
            echo 'Pipeline completed successfully.'
        }
        failure {
            echo 'Pipeline failed Successfully.'
        }
    }
}
